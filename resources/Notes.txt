# -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
# Tiff 2 PDF Derivative Generation Plugin
# DOCUMENTATION
# -=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-
#
# Monday,  14 April 2015  Ben O'Brien
# Created
#
#
#



# -=-=-=-=-=-=-=-=-=-=-
# Issues
# -=-=-=-=-=-=-=-=-=-=-

# Versions of ImageMagick
There were three versions of ImageMagick on Hokai server. Depending on whether the script was run within or outside Rosetta, which user and which unix shell, the script could be invoking any of the three instances on the server. The script is harcoded to use 'convert' from path '/opt/csw/bin/', which is ImageMagick V6.2.9.

# ImageMagick Memory
Using the default configuration for merging images into a PDf, ImageMagick was running out of physical memory with large collections. A memory allocation error was appearing in logs, and swap file usage to getting up between 11-13GB. The following parameters were passed with the convert command '-limit area 0 -limit map 0' to force writing to disk rather than memory.

# Solaris File Limit
"convert: unable to open image `/export/home/username/tmp/page-68.jpg': Too many open files."
ImageMagick appeared to be failing from a Solaris open files limit. We made the script set the Open File Descriptors limit to 30,000, but merging greater than 256 images was still failing. He discovered it was a bug with ImageMagick on Solaris. The same process was tested on a Red Hat VM and worked. We decided to take an alternative approach and merge the images into a series of smaller intermediate PDFs before merging into the final one.

# Final PDF size
Comparing the PDFs against the Natlib 'Books on Screen' series http://natlib.govt.nz/blog/posts/books-on-screen, we found ImageMagick was producing PDFs over 1.5 times the size as those in that series. In order to reduce that size, we tested various quality, image dimensions and blur effects on the jpegs to get an optimal PDF size. Those jpeg conversion settings were '-filter Gaussian -resize '75%' -density 300 -quality 40'.

# Total Execution time
Processing time was costly for converting and merging large collections. The initial conversion to jpegs was lengthy and not avoidable. But the merging to PDf time was significantly reduced by not using ImageMagick for this process. A combination of sam2p and Sejda was used.



# -=-=-=-=-=-=-=-=-=-=-
# Execution Chain
# -=-=-=-=-=-=-=-=-=-=-

Tiff -> JPEG	=>		JPEG -> PDF		=>		Merge into single PDf
ImageMagick				sam2p					Sejda

# Tiff -> JPEG
ImageMagick was used for this step to convert tiff files to jpegs. Calling the convert command with the following settings '-filter Gaussian -resize '75%' -density 300 -quality 40'.

# JPEG -> PDF
This was a one-to-one conversion by sam2p, creating one PDf for each jpeg. ImageMagick appeared to be doing additional compression when merging to PDf, increasing the output size and processing time, and strangley reducing the quality. The speed was increased and quality/compression maintained by using sam2p. Usage: 'sam2p <input_file> <output_pdf>'.

# Merge into single PDf
This was performed by a command line PDf manipulation tool - Sejda. Fast and maintained quality/compression of PDFs generated by sam2p. Usage: 'sejda-console merge -d <input_dir> -o <output_pdf>'.



# -=-=-=-=-=-=-=-=-=-=-
# Tools
# -=-=-=-=-=-=-=-=-=-=-

# sam2p
https://code.google.com/p/sam2p/
http://pts.szit.bme.hu/sam2p/
The download package used was sam2p-0.49.2.tar.gz. This c++ tool needs to be compiled from source - Unix system requirements lines 463-474 in Readme file. Also building instructions on lines 476-489 in Readme. Binary compiled on Hokai can be found in svn repo.
Location on Hokai: /exlibris/product/sam2p
Owned by DPS

# Sejda
http://www.sejda.org/
http://www.sejda.org/shell-interface/tutorial/
The download package used was sejda-console-1.0.0.M10-bin.zip. This Java tool came pre-compiled, and is invoked via a shell script. Sejda console uses the default Java JDK set in $JAVA_HOME, if none is provided when invoking the script. The current default on Hokai is 1.7.0_71.
Location on Hokai: /exlibris/product/sejda-console-1.0.0.M10
Owned by DPS



# -=-=-=-=-=-=-=-=-=-=-
# Benchmarking
# -=-=-=-=-=-=-=-=-=-=-

# Outside of Rosetta - uninterrupted

1083 files - avg size 40-50MB, total 50GB
Tiff -> JPEG (ImageMagick)
Conversion start: Mon Apr 13 11:32:36 NZST 2015
Conversion end: Mon Apr 13 13:52:55 NZST 2015

JPEG -> PDF (sam2p)
Conversion start: Mon Apr 13 13:59:50 NZST 2015
Conversion end: Mon Apr 13 14:00:37 NZST 2015

Merge (sejda)
Mon Apr 13 14:01:50 NZST 2015
Mon Apr 13 14:02:31 NZST 2015

Output: 245MB


345 files - avg size 5-10MB, total 2.3GB
Tiff -> JPEG (ImageMagick)
Conversion start: Mon Apr 13 14:41:39 NZST 2015
Conversion end: Mon Apr 13 14:57:02 NZST 2015

JPEG -> PDF (sam2p)
PDf generation start: Mon Apr 13 14:57:03 NZST 2015
PDf generation end: Mon Apr 13 14:57:12 NZST 2015

Merge (sejda)
PDf merging start: Mon Apr 13 14:57:12 NZST 2015
PDf merging start: Mon Apr 13 14:57:27  NZST 2015

Output: 50MB


182 files - avg size 41-51MB, total 7.8GB
Tiff -> JPEG (ImageMagick)
Conversion start: Mon Apr 13 15:32:07 NZST 2015
Conversion end: Mon Apr 13 15:57:05 NZST 2015

JPEG -> PDF (sam2p)
PDf generation start: Mon Apr 13 15:57:05 NZST 2015
PDf generation end: Mon Apr 13 15:57:12 NZST 2015

Merge (sejda)
PDf merging start: Mon Apr 13 15:57:12 NZST 2015
PDf merging end: Mon Apr 13 15:57:22 NZST 2015

Output: 68MB


179 files - avg size 4-8MB, total 870MB
Tiff -> JPEG (ImageMagick)
Conversion start: Mon Apr 13 16:05:36 NZST 2015
Conversion end: Mon Apr 13 16:12:31 NZST 2015

JPEG -> PDF (sam2p)
PDf generation start: Mon Apr 13 16:12:31 NZST 2015
PDf generation end: Mon Apr 13 16:12:34 NZST 2015

Merge (sejda)
PDF merging start: Mon Apr 13 16:12:34 NZST 2015
PDF merging end: Mon Apr 13 16:12:42 NZST 2015

Output: 15MB


73 files - avg size 5-8MB, total 448MB
Tiff -> JPEG (ImageMagick)
Conversion start: Mon Apr 13 16:17:14 NZST 2015
Conversion end: Mon Apr 13 16:19:04 NZST 2015

JPEG -> PDF (sam2p)
PDf generation start: Mon Apr 13 16:19:04 NZST 2015
PDf generation end: Mon Apr 13 16:19:05 NZST 2015

Merge (sejda)
PDF merging start: Mon Apr 13 16:19:05 NZST 2015
PDF merging end: Mon Apr 13 16:19:12 NZST 2015

Output: 8.7MB


54 files - avg size 200-460MB, total 21GB
Tiff -> JPEG (ImageMagick)
Conversion start: Tue Apr 14 09:10:59 NZST 2015
Conversion start: Tue Apr 14 09:50:01 NZST 2015

JPEG -> PDF (sam2p)
PDf generation start: Tue Apr 14 09:50:01 NZST 2015
PDf generation end: Tue Apr 14 09:50:03 NZST 2015

Merge (sejda)
PDF merging start: Tue Apr 14 09:50:03 NZST 2015
PDF merging end: Tue Apr 14 09:50:11 NZST 2015

Output: 58.5MB

